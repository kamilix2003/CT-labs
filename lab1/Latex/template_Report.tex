\documentclass[notitlepage, a4paper, 11pt]{article}

\usepackage{geometry}
\geometry{
	a4paper,
	total={170mm,257mm},
	left=20mm,
	top=20mm,
}

\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{minted}
\usepackage{tikz}
\usepackage[european resistors]{circuitikz}
\usepackage{caption}
\usepackage{subcaption}

\title{Nodal Analysis\\
	\large Laboratory I}
\author{Patrycja Nazim, Adrian Król, Kamil Chaj}
\date{}

\begin{document}
	\maketitle
	\section{Aim of exercise}
	The aim of our exercise was to experimentally verify the nodal analysis in RLC circuits. We have achieved it by measuring the voltages on different nodes of the chosen circuits using a dedicated evaluation board and vector voltmeter. The obtained measurement results are compared with analytical calculations.
	
	Apart from the values of potentials in individual nodes of the circuits being measured, we calculated the currents flowing through pointed elements.

	\section{Course of measurements}
	First step of our measurements was connecting evaluation board(fig.\ref{fig:ms}) to laboratory computer via USB and starting Vector Voltage Meter software. Next we connected both INPUT1 and CON1 to OUTPUT using BNC cables and splitter, last we connected oscilloscope probe to INPUT2 connector. Now with all preparation finished we started voltage measurements of each node in Circuit A(fig.\ref{fig:A}). Then we disconnected BNC cable connected to CON1 and connected it to CON2 and repeated previous measurements for Circuit B(fig.\ref{fig:B})
	
	\begin{figure}[!ht]
		\begin{center}
			\begin{circuitikz}
				\draw(0, 0)node[bnc](I1){INPUT1};
				\draw [black, ->](I1.hot) -- (3, 0) -- (3, -0.5);
				\draw(3, -0.57)node[right]{node} to[short, -*](3, -0.57);
				\draw(0, -1)node[bnc](I2){INPUT2};
				\draw [black, ->](I2.hot) -- (-1.5, -1) -- (-1.5, -2);
				\draw(0, -2)node[bnc](O){OUTPUT};
				\draw(3, -2)node[bnc, rotate=180](D) {};
				\draw(-3,-2)node[ground] {}
				to[vsourcesin](-1.5,-2)
				to[short](O.hot);
				\draw [black, ->](O.hot) -- (D.hot);
				\draw [black, thick](-4,1) rectangle (0.9, -3);
				\draw [black, thick](2,1) rectangle (4, -3);
				\draw(-1.5, 1.2) node[short]{EVALUATION BOARD} (-1.5, 1.2);
				\draw(3, 1.2) node[short]{DUT} (3, 1.2);
				\draw(3, 0.2) node[short]{probe} (3, 0.2);
				\draw(3, -2.5) node[short]{CON1/2} (3, -2.5);
			\end{circuitikz}
		\end{center}
		\caption{measurements schematic}
		\label{fig:ms}
	\end{figure}

	\section{Nodal analysis - method}
	Method which we are going to use to solve these circuits is known as "Nodal Analysis by Inspection". In this method we need to construct 3 matrices: $\mathbf{i}$ - current vector, $\mathbf{u}$ - voltage vector(unknown), $\mathbf{G}$ - conductance matrix, with sizes respectively $\mathit{N} \times 1$, $\mathit{N} \times 1$, $\mathit{N}-1 \times \mathit{N}-1$.
	
	Size of conductance matrix is always smaller then number of nodes in the circuit by one because in nodal analysis one node is connected to ground.

		\begin{center} $\mathbf{Gu=i}$ \end{center}
		\begin{center}
			\begin{math}
				\begin{bmatrix}
					G_{11} & -G_{12} & -G_{13} \\
					-G_{21} & G_{22} & -G_{23} \\
					-G_{31} & -G_{32} & G_{33} 
				\end{bmatrix}
				\begin{bmatrix}
					U_1 \\
					U_2 \\ 
					U_3
				\end{bmatrix}
				=
				\begin{bmatrix}
					I_1 \\
					I_2 \\
					I_3
				\end{bmatrix}
			\end{math}
		\end{center}
		Where $G_{11}$, $G_{22}$, $G_{33}$ are sums of conductance of each branch connected to the node \newline $G_{12} = G_{21}$, $G_{13} = G_{31}$, $G_{32} = G_{23}$ are sums of conductance of branches between nodes \newline $I_1, I_2, I_3$ are sums of current sources entering or exiting node and $U_1, U_2, U_3$ are unknown voltages that we are trying to find.
		\newline\newline
		With simple matrix operation we obtain equation
		$$
		\mathbf{u} = \mathbf{G}^{-1}\mathbf{i}
		$$
		which can be easily calculated
	\section{Theoretical calculations}
	all calculation are made in Python with NumPy library. Source code for all calculation can be found in the Appendix
	
	Before starting any calculation we modified original circuits' schematics by replacing BNC connectors with AC voltage source and drawing connection between ground
	\subsection{Circuit A}
	In our calculations voltages in nodes 1, 3 and 4 are named $U_1, U_3, U_4$ and grounded node is the same node that was ground in original circuit schematic. Lone voltage source must be transfigured to solve this circuit with nodal analysis
	
		\begin{figure}[!ht] %circuit A
		\centering
				\begin{subfigure}{0.45\textwidth}
					\centering
						\begin{circuitikz}[scale = 0.7, transform shape]
						\draw 
						(2,-2) to[vsourcesin, l=V] (2,0)
						node[left]{$U_1$}to[short, *-](2,2)
						to[R, l=$R_{11}$, a=1k$\Omega$] (6,2)
						node[above]{2}to[short, *-](6,2)
						to[C, l=$C_{11}$, a=100nF] (10,2) -- (10,0)
						node[right]{$U_4$}to[short,*-](10,0)
						to[R, l=$R_{12}$, a=1k$\Omega$] (6,0)
						node[above]{$U_3$}to[short, -*](6,0)
						to[C, l=$C_{12}$, a=47nF, i<=$I_{C_{12}}$] (2,0)
						;
						\draw 
						(6,0)
						to[L, l=$L_{11}$, a=10mH](6,-2)
						;
						\draw 
						(10,0) to[C, l=$C_{13}$, a=22nF](10,-2)
						;
						\draw (2,-2)
						to[short](10,-2);
						\draw (6,-2)
						node[rground] {} (6,-2);
					\end{circuitikz}
					\caption{}
				\end{subfigure}
				\begin{subfigure}{0.45\textwidth}
					\centering
						\begin{circuitikz}[scale = 0.7, transform shape]
							\draw 
							(2,-2) to[short] (2,0)
							node[left]{$U_1$}to[short, *-](2,0)
							to[vsourcesin, l=V](2,2)
							to[R, l=$R_{11}$, a=1k$\Omega$] (6,2)
							node[above]{2}to[short, *-](6,2)
							to[C, l=$C_{11}$, a=100nF] (10,2) -- (10,0)
							node[right]{$U_4$}to[short,*-](10,0)
							to[R, l=$R_{12}$, a=1k$\Omega$] (6,0)
							node[above]{$U_3$}to[short, -*](6,0)
							to[C, l=$C_{12}$, a=47nF, i<=$I_{C_{12}}$](3,0)
							to[vsourcesin, l=V](2,0)
							;
							\draw 
							(6,0)
							to[L, l=$L_{11}$, a=10mH](6,-2)
							;
							\draw 
							(10,0) to[C, l=$C_{13}$, a=22nF](10,-2)
							;
							\draw (2,-2)
							to[short](10,-2);
							\draw (6,-2)
							node[rground] {} (6,-2);
						\end{circuitikz}
						\caption{}
				\end{subfigure}
			\caption{theoretical circuit A}
			\label{fig:tA}
	\end{figure}

	\begin{math}
		\centering
		\begin{bmatrix}
			G_{R_{11}+C_{11}} + G_{C_{12}} & G_{C_{12}} & G_{R_{11}+C_{11}}\\
			G_{C_{12}} & G_{C_{12}} + G_{L_{11}} + G_{R_{12}} & G_{R_{12}}\\ 
			G_{R_{11}}+G_{C_{11}} & G_{C_{12}} & G_{R_{11}+C_{11}} + G_{R_{12}} + G_{C_{12}}
		\end{bmatrix}
		\begin{bmatrix}
			U_1\\
			U_3\\
			U_4
		\end{bmatrix}
		=
		\begin{bmatrix}
			I1\\
			I3\\
			I4
		\end{bmatrix}
	\end{math}
	\newline
	Current of the capacitor $C_{12}$ can be calculated using $I_{C_{12}} = \frac{U_3 - U_2}{Z_{C_{12}}}$
	
	\subsubsection*{results of calculations}
	source code in Appendix. \ref{code:A}
	\begin{center}
		!!!WRONG RESULTS... I THINK!!!
		\resizebox{165mm}{!}{
			\begin{tabular}{lrr}
				\hline
				1000.0 Hz   &   Magnitude &    Phase \\
				\hline
				Node 2      & 0.192       & 180      \\
				Node 3      & 1.22663e-18 & 135      \\
				Node 4      & 0           &   0      \\
				I of C\_12   & 5.66995e-05 &  -1.5708 \\
				\hline
			\end{tabular}
		\begin{tabular}{lrr}
			\hline
			5000.0 Hz   &   Magnitude &     Phase \\
			\hline
			Node 2      & 0.192       & -180      \\
			Node 3      & 2.86098e-17 &  104.036  \\
			Node 4      & 1.43049e-17 &   14.0362 \\
			I of C\_12   & 0.000283497 &   -1.5708 \\
			\hline
		\end{tabular}
		\begin{tabular}{lrr}
			\hline
			9000.0 Hz   &   Magnitude &     Phase \\
			\hline
			Node 2      & 0.192       &  180      \\
			Node 3      & 5.72196e-17 & -165.964  \\
			Node 4      & 2.08167e-17 &  -90      \\
			I of C\_12   & 0.000510295 &   -1.5708 \\
			\hline
		\end{tabular}
	}
	\end{center}

	\newpage
	\subsection{Circuit B}
		\begin{figure}[!ht] %circuit B
		\begin{center}
			\begin{circuitikz}[scale = 0.75, transform shape]
				\draw (0,0)
				to[vsourcesin, l=V](2,0)
				node[above]{1}to[short,*-,](2,0)
				to[C, l=$C_{22}$, a=22nF](4,0)
				node[right]{3}to[short,-*](4,0)
				;
				\draw (0,3)
				to[R, l=$R_{21}$, a=1k$\Omega$](4,3)
				node[above]{2}to[short, -*](4,3)
				;
				\draw (0,-3)
				to[C, l=$C_{23}$, a=100nF](4,-3)
				node[below]{4}to[short, -*](4,-3)
				;
				\draw 
				(4,3) -- (7,3)
				to[R, l=$R_{22}$, a=1k$\Omega$, i=$I_{R_{22}}$](7,-3) -- (4,-3)
				to[L, l=$L_{21}$, a=10mH](4,0)
				to[C, l=$C_{21}$, a=47nF](4,3)
				;
				\draw (0,3)
				to[short](0,-3);
				\draw (0,0)
				node[rground, rotate=-90] {} (0,0);
			\end{circuitikz}
			\label{fig:tB}
			\caption{theoretical circuit B}
		\end{center}
	\end{figure}
	Current of the resistor $R_{22}$ can be calculated using $I_{R_{22}} = \frac{U_4 - U_2}{Z_{R_{22}}}$
	
	\newpage
	\section{Real measurements}
	\subsection{Circuit A}
			\begin{figure}[!ht] %circuit A
			\begin{center}
				\begin{circuitikz}[scale = 0.75, transform shape]
					\draw 
					(1,0) node[bnc](B){CON2} to[short](2,0)
					node[below]{1}to[short, *-](2,2)
					to[R, l=$R_{11}$, a=1k$\Omega$] (6,2)
					node[above]{2}to[short, *-](6,2)
					to[C, l=$C_{11}$, a=100nF] (10,2) -- (10,0)
					node[left]{4}to[short,*-](10,0)
					to[R, l=$R_{12}$, a=1k$\Omega$] (6,0)
					node[above]{3}to[short, -*](6,0)
					to[C, l=$C_{12}$, a=47nF, i<=$I_{C_{12}}$] (2,0)
					;
					\node[ground] at (B.shield){};
					\draw 
					(6,0)
					to[L, l=$L_{11}$, a=10mH](6,-2)
					to[short] node[ground] {} (6,-2)
					;
					\draw 
					(10,0) to[C, l=$C_{13}$, a=22nF](10,-2)
					to[short] node[ground] {} (10,-2)
					;
				\end{circuitikz}
				\caption{circuit A}
				\label{fig:A}
			\end{center}
		\end{figure}
	
		\begin{table}[!ht] %table circuit A
		\begin{center}
			\resizebox{75mm}{!}{
			\begin{tabular}{|c|c|c|c|}
				\hline
				\multicolumn{4}{|c|}{Circuit A} \\
				\hline
				Freq[kHz] & Channel 1[V] & Channel 2 [V] & Angle [°] \\
				\hline
				\multicolumn{4}{|c|}{node 1} \\
				\hline
				1kHz & 0.192 & 0.192 & 0 \\
				\hline
				5kHz & 0.192 & 0.192 & -0.1 \\
				\hline
				9kHz & 0.192 & 0.192 & -0.1 \\
				\hline
				\multicolumn{4}{|c|}{node 2} \\
				\hline
				1kHz & 0.192 & 0.145 & -19.3 \\
				\hline
				5kHz & 0.192 & 0.59 & 9.3 \\
				\hline
				9kHz & 0.192 & 0.236 & -9.7 \\
				\hline
				\multicolumn{4}{|c|}{node 3} \\
				\hline
				1kHz & 0.192 & 0.008 & 140.7 \\
				\hline
				5kHz & 0.192 & 0.154 & 136.1 \\
				\hline
				9kHz & 0.192 & 0.376 & 30 \\
				\hline
				\multicolumn{4}{|c|}{node 4} \\
				\hline
				1kHz & 0.192 & 0.072 & 38.6 \\
				\hline
				5kHz & 0.192 & 0.082 & 42.1 \\
				\hline
				9kHz & 0.192 & 0.231 & -11.8 \\
				\hline
			\end{tabular}
		}	
		\end{center}
		\label{tab:A}
		\caption{evaluation board measurements for Circuit A}
	\end{table}
	Current of capacitor $C_{12}$
	\begin{tabular}{|c|c|}
			\hline
			freq [kHz] & $I_{R_{22}}$ \\
			\hline
			1kHz &  \\
			\hline
			5kHz &  \\
			\hline
			9kHz &  \\
			\hline
	\end{tabular}
	\newpage
	\subsection{Circuit B}
		\begin{figure}[!ht] %circuit B
			\begin{center}
				\begin{circuitikz}[scale = 0.75, transform shape]
					\draw (0,0)
					node[bnc](B){CON2} to[short](2,0)
					node[above]{1}to[short,*-,](2,0)
					to[C, l=$C_{22}$, a=100nF](4,0)
					node[right]{3}to[short,-*](4,0)
					;
					\node[ground] at (B.shield){};
					\draw 
					(0,3) node[ground]{}
					to[R, l=$R_{21}$, a=1k$\Omega$](4,3)
					node[above]{2}to[short, -*](4,3)
					;
					\draw 
					(0,-3) node[ground]{}
					to[C, l=$C_{23}$, a=100nF](4,-3)
					node[below]{4}to[short, -*](4,-3)
					;
					\draw 
					(4,3) -- (7,3)
					to[R, l=$R_{22}$, a=1k$\Omega$, i=$I_{R_{22}}$](7,-3) -- (4,-3)
					to[L, l=$L_{21}$, a=10mH](4,0)
					to[C, l=$C_{21}$, a=47nF](4,3)
					;
				\end{circuitikz}
				\caption{circuit B}
				\label{fig:B}
			\end{center}
		\end{figure}
				\begin{table}[!ht] %table circuit B
				\begin{center}
					\resizebox{75mm}{!}{
					\begin{tabular}{|c|c|c|c|}
						\hline
						\multicolumn{4}{|c|}{Circuit B} \\
						\hline
						Freq[kHz] & Channel 1[V] & Channel 2 [V] & Angle [°] \\
						\hline
						\multicolumn{4}{|c|}{node 1} \\
						\hline
						1kHz & 0.192 & 0.192 & 0 \\
						\hline
						5kHz & 0.192 & 0.192 & -0.1 \\
						\hline
						9kHz & 0.192 & 0.192 & 0 \\
						\hline
						\multicolumn{4}{|c|}{node 2} \\
						\hline
						1kHz & 0.192 & 0.044 & 28.7 \\
						\hline
						5kHz & 0.192 & 0.044 & -35.7 \\
						\hline
						9kHz & 0.192 & 0.156 & 69.7 \\
						\hline
						\multicolumn{4}{|c|}{node 3} \\
						\hline
						1kHz & 0.192 & 0.084 & 23.3 \\
						\hline
						5kHz & 0.192 & 0.055 & 62.4 \\
						\hline
						9kHz & 0.192 & 0.22 & 24.4 \\
						\hline
						\multicolumn{4}{|c|}{node 4} \\
						\hline
						1kHz & 0.192 & 0.086 & 21.2 \\
						\hline
						5kHz & 0.192 & 0.18 & -11.8 \\
						\hline
						9kHz & 0.192 & 0.09 & -113.8 \\
						\hline
					\end{tabular}
			}
			\end{center}
			\label{tab:B}
			\caption{evaluation board measurements for Circuit B}
		\end{table}
		\begin{tabular}{|c|c|}
			\hline
			freq [kHz] & $I_{R_{22}}$ \\
			\hline
			1kHz &  \\
			\hline
			5kHz &  \\
			\hline
			9kHz &  \\
			\hline
		\end{tabular}
	\section{Comparison}
	\section{Summery}
	\newpage
	\appendix
	\section*{Appendix}\label{Appendix}
	\section{Source code circuit A}
	\inputminted{python}{../CircuitA.py}
	\label{code:A}
	\newpage
	\section{Source code circuit B}
	\inputminted{python}{../CircuitB.py}
	\label{code:B}
\end{document}